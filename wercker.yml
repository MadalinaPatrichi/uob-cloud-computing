box: openjdk:8

build:
  steps:
    - script:
      name: gradle test
      cwd: app
      code: |
        ./gradlew test
    - script:
      name: gradle build
      cwd: app
      code: |
        ./gradlew build
    - script:
      name: clean
      code: |
        rm -rf app/.gradle

deploy-docs:
  steps:
    - script:
      name: build and deploy docs
      cwd: app
      code: echo noop

build-docs:
  box: node:10
  steps:
    - script:
      name: build gitbook
      cwd: content
      code: |
        npm install gitbook-cli
        ./node_modules/gitbook-cli/bin/gitbook.js build
        find book

build-docker:
  steps:
    - internal/docker-build:
      cwd: app
      dockerfile: Dockerfile.multi_stage
      image-name: uobcloudcomputing/todoapp

deploy-docker:
  steps:
    - internal/docker-push:
      username: $DOCKER_USERNAME
      password: $DOCKER_PASSWORD
      tag: latest
      repository: uobcloudcomputing/todoapp
    
deploy-jar:
  box: python:2.7
  steps:
    - script:
      name: deploy jar
      cwd: app
      code: python ./release-jar.py
