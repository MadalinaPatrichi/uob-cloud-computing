box: openjdk:8

build:
  steps:
    - script:
      name: gradle test
      cwd: app
      code: |
        ./gradlew test
    - script:
      name: gradle build
      cwd: app
      code: |
        ./gradlew build
    - script:
      name: clean
      code: |
        rm -rf app/.gradle

build-docs:
  box: node:10
  steps:
    - script:
      name: build gitbook
      cwd: content
      code: |
        env
        npm install gitbook-cli
        ./node_modules/gitbook-cli/bin/gitbook.js build
        find book
        mkdir ~/.ssh
        echo "$GH_PAGES_KEY_PRIVATE" > ~/.ssh/id_rsa
        chown 0700 ~/.ssh
        chown 0600 ~/.ssh/id_rsa
        git config --global user.name "$WERCKER_STARTED_BY"
        git config --global user.email "root@$HOSTNAME.com"
        git clone git@github.com:MadalinaPatrichi/uob-cloud-computing.git out
        cd out
        git checkout gh-pages || git checkout --orphan gh-pages
        git rm -rf .
        cd ..
        cp -a _book/* out/
        cd out
        git add -A
        git commit -m "Automated deployment to GitHub Pages ($WERCKER_GIT_COMMIT)" --allow-empty
        git push origin gh-pages

deploy-docs:
  box: alpine/git:latest
  steps:
    - script:
      name: deploy docs
      cwd: app
      code: |
        env

build-docker:
  steps:
    - internal/docker-build:
      cwd: app
      dockerfile: Dockerfile.multi_stage
      image-name: uobcloudcomputing/todoapp

deploy-docker:
  steps:
    - internal/docker-push:
      username: $DOCKER_USERNAME
      password: $DOCKER_PASSWORD
      tag: latest
      repository: uobcloudcomputing/todoapp
    
deploy-jar:
  box: python:2.7
  steps:
    - script:
      name: deploy jar
      cwd: app
      code: python ./release-jar.py
